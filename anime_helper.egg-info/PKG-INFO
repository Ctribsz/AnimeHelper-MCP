Metadata-Version: 2.4
Name: anime-helper
Version: 0.1.0
Summary: MCP server for Anime & Manga (AniList + Jikan) returning structured JSON.
Project-URL: Homepage, https://github.com/Ctribsz/AnimeHelper-MCP
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: mcp[cli]>=1.2.1
Requires-Dist: requests>=2.32.0

# anime-helper (MCP server)

Servidor **Model Context Protocol (MCP)** para **Anime & Manga** que entrega **JSON estructurado** desde **AniList GraphQL** (sin API key) con **Jikan** (MyAnimeList) como *fallback*.
El **LLM del host** usa estos datos para redactar resÃºmenes, recomendaciones y respuestas al usuario.

* ğŸ” `search_media` â€” bÃºsqueda de ANIME/MANGA (AniList por defecto; Jikan fallback)
* ğŸ“„ `media_details` â€” ficha normalizada (tÃ­tulos, formato/estado, episodios/capÃ­tulos, gÃ©neros, sinopsis, enlaces externos, recomendaciones)
* ğŸ“ˆ `trending` â€” lo que estÃ¡ en tendencia (AniList)
* ğŸ©º `health` / â„¹ï¸ `about` â€” diagnÃ³stico y metadatos del servidor
* ğŸ§± **Contrato estable** con `schemaVersion`, *timeouts*, **reintentos con backoff** y **errores uniformes**

> **No necesitas API key** para AniList ni Jikan.

---

## Requisitos

* Python **3.10+**
* `pip`
* Un **host MCP** (por ejemplo, tu host OpenAI por STDIO)

---

## InstalaciÃ³n

### OpciÃ³n A â€” desde **tag** (recomendado para usuarios)

```bash
pip install -U --no-cache-dir git+https://github.com/Ctribsz/AnimeHelper-MCP.git@v0.1.0
```

### OpciÃ³n B â€” desde **main** (Ãºltimo cÃ³digo)

```bash
pip install -U --no-cache-dir git+https://github.com/Ctribsz/AnimeHelper-MCP.git@main
```

### OpciÃ³n C â€” modo dev (editable)

```bash
git clone https://github.com/Ctribsz/AnimeHelper-MCP
cd AnimeHelper-MCP
python -m venv .venv
# Linux/Mac:
source .venv/bin/activate
# Windows (PowerShell):
.\.venv\Scripts\Activate.ps1

pip install -U pip
pip install -e .
```

---

## Uso desde un host MCP (STDIO)

En el `mcp.config.json` de tu host aÃ±ade:

```json
{
  "servers": {
    "anime-helper": {
      "command": "python",
      "args": ["-m", "anime_helper.server"],
      "transport": "stdio"
    }
  }
}
```

Arranca tu host (ejemplo OpenAI):

```bash
python -m src.host_openai
```

DeberÃ­as ver algo como:

```
âœ”ï¸ Conectado a 'anime-helper' con herramientas: ['search_media', 'media_details', 'trending', 'health', 'about']
```

---

## Prompts de prueba (para el chat del host)

1. **BÃºsqueda**

```
Usa anime-helper__search_media {"query":"one piece","kind":"ANIME","limit":3} y muÃ©strame los tÃ­tulos con su id.
```

2. **Detalles (AniList)**

```
Llama anime-helper__media_details {"source":"anilist","id":21,"kind":"ANIME"} y resume en 5 puntos. Cita la URL.
```

3. **Tendencia (Manga)**

```
Usa anime-helper__trending {"kind":"MANGA","limit":5} y ordÃ©nalos por score descendente con tÃ­tulo y aÃ±o.
```

4. **Salud / versiÃ³n**

```
Ejecuta anime-helper__health y luego anime-helper__about para ver versiÃ³n y endpoints.
```

---

## Tools & contrato JSON

### `search_media(query, kind="ANIME|MANGA", source="anilist|jikan", limit=5)`

**Ã‰xito:**

```json
{
  "schemaVersion": "1.0.0",
  "query": "one piece",
  "kind": "ANIME",
  "source": "anilist",
  "results": [
    {
      "source": "anilist",
      "id": 21,
      "idMal": 21,
      "titles": {"romaji":"One Piece","english":"One Piece","native":"ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹"},
      "year": 1999,
      "format": "TV",
      "episodes": 1100,
      "chapters": null,
      "score": 86,
      "url": "https://anilist.co/anime/21"
    }
  ]
}
```

### `media_details(source, id, kind="ANIME|MANGA")`

**Ã‰xito (campos principales):**

```json
{
  "schemaVersion": "1.0.0",
  "source": "anilist",
  "id": 21,
  "idMal": 21,
  "titles": {"romaji":"One Piece","english":"One Piece","native":"ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹"},
  "format": "TV",
  "status": "RELEASING",
  "episodes": 1100,
  "chapters": null,
  "genres": ["Action","Adventure"],
  "tags": ["Shounen", "Pirates"],
  "score": {"anilist": 86, "mal": null},
  "synopsis": "â€¦",
  "url": "https://anilist.co/anime/21",
  "external": [{"site":"Official","url":"â€¦"}],
  "recommendations": [ /* MediaHit[] */ ]
}
```

### `trending(kind="ANIME|MANGA", limit=10)`

**Ã‰xito:**

```json
{
  "schemaVersion": "1.0.0",
  "kind": "MANGA",
  "results": [ /* MediaHit[] */ ]
}
```

### `health()` / `about()`

```json
{"schemaVersion":"1.0.0","ok":true,"sources":["anilist","jikan"]}
```

```json
{
  "schemaVersion": "1.0.0",
  "name": "anime-helper",
  "version": "0.1.0",
  "endpoints": {"anilist": "https://graphql.anilist.co", "jikan": "https://api.jikan.moe/v4"},
  "limits": {"maxPerPage": 25, "timeoutSec": 15}
}
```

### Errores (uniforme)

```json
{
  "schemaVersion": "1.0.0",
  "error": {
    "code": "UPSTREAM_429",
    "message": "rate limited by upstream",
    "source": "anilist"
  }
}
```

---

## Smoke test (opcional, desde tu host)

Crea `scripts/smoke_test.sh`:

```bash
#!/usr/bin/env bash
set -euo pipefail
printf "anime-helper__health\nanime-helper__search_media {\"query\":\"one piece\",\"kind\":\"ANIME\",\"limit\":2}\nsalir\n" | python -m src.host_openai
```

Linux/Mac:

```bash
chmod +x scripts/smoke_test.sh
./scripts/smoke_test.sh
```

Windows (PowerShell):

```powershell
"anime-helper__health`nanime-helper__search_media {""query"":""one piece"",""kind"":""ANIME"",""limit"":2}`nsalir" | python -m src.host_openai
```

---

## SoluciÃ³n de problemas

* **No aparecen las tools** â†’ confirma instalaciÃ³n:

  ```bash
  pip show anime-helper
  ```

  y la entrada en `mcp.config.json`.

* **429/5xx** â†’ reintenta; el server implementa backoff. Baja `limit` si persiste.

* **Sin Internet** â†’ AniList/Jikan requieren red.

---

## Arquitectura (modular)

El servidor se ha modularizado para mejorar mantenibilidad y pruebas. Estructura principal:

```
anime_helper/
â”œâ”€â”€ __init__.py                 # exporta create_app()
â”œâ”€â”€ server.py                   # entrypoint: instancia FastMCP y registra tools
â”œâ”€â”€ server_legacy.py            # copia de seguridad del servidor monolÃ­tico (temporal)
â”œâ”€â”€ core/                       # nÃºcleo: red, cache y normalizadores
â”‚   â”œâ”€â”€ http_client.py          # http_get/http_post + err_payload
â”‚   â”œâ”€â”€ cache.py                # cache GQL + funciÃ³n gql()
â”‚   â””â”€â”€ normalizers.py          # normalizadores AniList (Title/MediaHit/Details)
â”œâ”€â”€ models/
â”‚   â””â”€â”€ types.py                # TypedDicts: Title, MediaHit, Details, AiringItem
â”œâ”€â”€ tools/                      # herramientas MCP (cada archivo registra sus tools)
â”‚   â”œâ”€â”€ search.py               # search_media, resolve_title
â”‚   â”œâ”€â”€ details.py              # media_details
â”‚   â”œâ”€â”€ trending.py             # trending, season_top
â”‚   â”œâ”€â”€ airing.py               # airing_status, airing_calendar
â”‚   â”œâ”€â”€ cache_tools.py          # cache_info, cache_clear
â”‚   â”œâ”€â”€ nlp.py                  # ask (router de lenguaje natural)
â”‚   â””â”€â”€ meta.py                 # health, help, help_text, about
â””â”€â”€ utils/
    â””â”€â”€ helpers.py              # season_from_month
```

Notas de diseÃ±o:

- **Registro explÃ­cito de tools**: cada mÃ³dulo en `tools/` expone `register_tools(mcp)` para evitar usar decoradores `@mcp.tool()` en tiempo de importaciÃ³n.
- **SeparaciÃ³n de concerns**: red/cache/normalizaciÃ³n/modelos separados de las herramientas MCP.
- **Backwards compatible**: `python -m anime_helper.server` sigue siendo el punto de entrada.

### Desarrollo local (rÃ¡pido)

```bash
python3 -m venv .venv
source .venv/bin/activate  # Linux/Mac
pip install -U pip
pip install -e .            # instala deps (incluye mcp[cli] y requests)

# smoke test de import/registro
python3 - << 'PY'
from anime_helper import create_app
app = create_app()
print('app ok:', bool(app))
PY
```

---

## Roadmap

- [ ] **Tests unitarios** para `core/` (http, cache, normalizers) aislando red con mocks.
- [ ] **Tipos estrictos** (mypy) y validaciÃ³n opcional de payloads (pydantic dataclasses ligeras).
- [ ] **Mejoras de NLP**: ampliar reglas, soportar sinÃ³nimos/espaÃ±ol neutro y variantes.
- [ ] **Config**: permitir `ANILIST_GQL`, `CACHE_TTL`, `DEFAULT_TIMEOUT` vÃ­a variables de entorno.
- [ ] **Docs**: ejemplos por herramienta en `README` con entradas/salidas reales (golden samples).
- [ ] **CI**: flujo simple (lint + tests) con GitHub Actions.

---

## Versionado

* El paquete declara versiÃ³n en `pyproject.toml` y `about()` la expone.
* Publica tags (ej. `v0.1.0`) y recomienda instalar por tag:

  ```bash
  pip install -U --no-cache-dir git+https://github.com/Ctribsz/AnimeHelper-MCP.git@v0.1.0
  ```
* Crear/actualizar tag:

  ```bash
  git add -A
  git commit -m "chore: bump version"
  git tag -a v0.1.1 -m "Release v0.1.1"
  git push origin main --tags
  ```

---

## Licencia

MIT (ver `LICENSE`).
